@page "/draws/draw-details/{drawId:int}"
@using RaffleKing.Data.Models
@inject IDrawService DrawService
@inject IPrizeService PrizeService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILocalStorageService LocalStorage

<PageTitle>Draw Details</PageTitle>

<MudStack Justify="Justify.Center" Spacing="6">
    <MudButton OnClick="@(() => NavigationManager.NavigateTo("javascript:history.back()"))"
               StartIcon="@Icons.Material.Filled.ArrowBack">
        Go Back
    </MudButton>
    @switch (_draw)
    {
        case { IsActive: false } when _prizes is { Count: > 0 }:
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" ContentAlignment="HorizontalAlignment.Center">
                This @_draw.DrawType.ToString() is ready to be published!
            </MudAlert>
            break;
        case {IsActive: false} when _prizes is {Count: 0}:
            <MudAlert Severity="Severity.Error" Variant="Variant.Filled" ContentAlignment="HorizontalAlignment.Center">
                This @_draw.DrawType.ToString() cannot be published until at least 1 prize is added!
            </MudAlert>
            break;
    }
    <MudText Typo="Typo.h1" Color="@Color.Tertiary" Align="Align.Center">@_draw?.Title</MudText>
    <MudGrid Justify="Justify.Center" Spacing="0">
        <MudItem>
            <MudContainer MaxWidth="MaxWidth.Small">
                <MudText Typo="Typo.h6" Color="Color.Primary">ABOUT THIS @_draw?.DrawType.ToString().ToUpper()</MudText>
                <MudPaper Class="pa-4 border-t-2 mud-border-primary">
                    <MudText Typo="Typo.body1">@_draw?.Description</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Tertiary" Class="mt-2">@_detailsText</MudText>
                    @if (_draw?.DrawType == DrawTypeEnum.Lottery)
                    {
                        <MudText Typo="Typo.body2" Color="Color.Tertiary" Class="mt-2">
                            In a Lottery, there is no guarantee of a winner. Any lucky number may be drawn, even if that
                            lucky number has not been selected. In such a case, the prize will not be won by anyone.
                        </MudText>
                    }
                </MudPaper>
            </MudContainer>
        </MudItem>
        <MudItem>
            <MudStack>
                <MudContainer MaxWidth="MaxWidth.ExtraSmall">
                    <MudText Typo="Typo.h6" Color="Color.Primary" Align="Align.Center">
                        DRAW DETAILS
                    </MudText>
                    <MudPaper Class="pa-4 border-t-2 mud-border-primary">
                        <MudGrid Justify="Justify.Center">
                            <MudItem>
                                <MudStack AlignItems="AlignItems.Center" Spacing="0">
                                    <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Size="Size.Large" Class="mb-2"/>
                                    <MudText Typo="Typo.button" Align="Align.Center" Style="line-height: 1.2">
                                        @_draw?.MaxEntriesPerUser max<br/>per person
                                    </MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem>
                                <MudStack AlignItems="AlignItems.Center" Spacing="0">
                                    <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Large" Class="mb-2"/>
                                    <MudText Typo="Typo.button" Align="Align.Center" Style="line-height: 1.2">
                                        Draw date:<br/>@_draw?.DrawDate.ToShortDateString()
                                    </MudText>
                                </MudStack>
                            </MudItem>
                            <MudItem>
                                <MudStack AlignItems="AlignItems.Center" Spacing="0">
                                    <MudIcon Icon="@Icons.Material.Filled.LocalActivity" Size="Size.Large" Class="mb-2"/>
                                    <MudText Typo="Typo.button" Align="Align.Center" Style="line-height: 1.2">
                                        @_draw?.MaxEntriesTotal<br/>total
                                        @(_draw?.DrawType == DrawTypeEnum.Raffle ? "tickets" : "entries")
                                    </MudText>
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudContainer>
                <MudContainer MaxWidth="MaxWidth.ExtraSmall">
                    <MudText Typo="Typo.h6" Color="Color.Primary" Align="Align.Center">
                        @(_userIsHost ? "DRAW ACTIONS" : "ENTER DRAW")
                    </MudText>
                    <MudPaper Class="pa-4 border-t-2 mud-border-primary">
                        @if (_userIsHost)
                        {
                            @if (_draw is { IsActive: false })
                            {
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Class="mb-4"
                                           OnClick="@AddPrize">
                                    Add Prize
                                </MudButton>
                            }
                            @if (_prizes is { Count: > 0 } && _draw is { IsActive: false })
                            {
                                <MudButton Variant="Variant.Filled" Color="Color.Info" FullWidth="true" Class="mb-4"
                                           OnClick="@PublishDrawWithConfirmation">
                                    Publish Draw
                                </MudButton>
                            }
                            <MudButton Variant="Variant.Filled" Color="Color.Error" FullWidth="true"
                                       OnClick="@DeleteDrawWithConfirmation">
                                Delete Draw
                            </MudButton>
                        }
                        else
                        {
                            <MudText Typo="Typo.button" Color="Color.Info">50% Total Entries Remaining</MudText>
                            <MudProgressLinear Striped="true" Color="Color.Info" Size="Size.Large" Value="50" Class="mt-0"/>
                            <MudText Typo="Typo.body1" Color="Color.Info" Class="mt-2">
                                You have entered this draw X times.
                            </MudText>
                            <MudSelect T="int" Label="@(_draw?.DrawType == DrawTypeEnum.Raffle ? "Entries" : "Lucky Numbers")"
                                       Variant="Variant.Filled" AnchorOrigin="Origin.BottomCenter" Immediate="true"
                                       MultiSelection="@(_draw?.DrawType == DrawTypeEnum.Lottery)" Value="1" Class="mt-4">
                                @if (_draw?.DrawType == DrawTypeEnum.Raffle)
                                {
                                    @for (var i = 1; i <= _availableEntries; i++)
                                    {
                                        <MudSelectItem Value="i"/>
                                    }
                                }
                                else if (_availableLuckyNumbers != null)
                                {
                                    foreach (var luckyNumber in _availableLuckyNumbers)
                                    {
                                        <MudSelectItem Value="luckyNumber"/>
                                    }
                                }
                            </MudSelect>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Class="mt-4">
                                Enter Draw
                            </MudButton>
                        }
                    </MudPaper>
                </MudContainer>
            </MudStack>
        </MudItem>
    </MudGrid>
    <MudStack Justify="Justify.Center">
        <MudText Typo="Typo.h6" Color="Color.Primary" Align="Align.Center">
            AVAILABLE PRIZES
        </MudText>
        <MudGrid Justify="Justify.Center">
            @if (_prizes != null)
            {
                foreach (var prize in _prizes)
                {
                    <MudItem>
                        <MudPaper Class="pa-4 border-t-2 mud-border-primary">
                            <MudText Typo="Typo.h6" Color="Color.Tertiary">@prize.Title</MudText>
                            <MudText Typo="Typo.body1">@prize.Description</MudText>
                            <MudText Typo="Typo.button" Color="Color.Primary">Quantity: @prize.Quantity</MudText>
                        </MudPaper>
                    </MudItem>
                }
            }
        </MudGrid>
    </MudStack>
</MudStack>
